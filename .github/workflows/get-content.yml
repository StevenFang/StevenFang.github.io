name: Update mi.json from URL

on:
  schedule:
    # 每天运行一次（可自行调整）
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch URL and generate mi.json
        run: |
          set -e

          URL="https://www.xn--sss604efuw.com/jm/jiemi.php?url=https://mitvbox.xyz/%E5%B0%8F%E7%B1%B3/DEMO.json"

          # 获取内容，删除前五行
          curl -fsSL "$URL" | tail -n +6 > mi.json.new

          # 如果原文件不存在，直接认为有更新
          if [ ! -f mi.json ]; then
            mv mi.json.new mi.json
            echo "UPDATED=true" >> $GITHUB_ENV
            exit 0
          fi

          # 对比新旧文件
          if diff -q mi.json mi.json.new >/dev/null; then
            echo "No changes detected."
            echo "UPDATED=false" >> $GITHUB_ENV
            rm mi.json.new
          else
            mv mi.json.new mi.json
            echo "Changes detected."
            echo "UPDATED=true" >> $GITHUB_ENV
          fi

      - name: Commit and push changes
        if: env.UPDATED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add mi.json
          git commit -m "chore: update mi.json"
          git push
