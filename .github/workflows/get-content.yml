name: Update 1.json from URL

on:
  schedule:
    # 每天运行一次（可自行调整）
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch URL and generate 1.json
        run: |
          set -e

          URL="https://www.xn--sss604efuw.com/jm/jiemi.php?url=https://cnb.cool/xiaomideyun/xiaomideyun/-/git/raw/main/mi.json"

          # 将原始响应保存到临时文件，便于检查
          curl -fsSL "$URL" -o response.tmp

          # 如果响应中包含 "解密失败"，则输出响应内容并放弃更新
          if grep -q "解密失败" response.tmp; then
            echo "Remote response contains 解密失败. Aborting update. Response content:"
            cat response.tmp
            # 标记为未更新，避免后续 commit 步骤
            echo "UPDATED=false" >> $GITHUB_ENV
            rm -f response.tmp
            exit 0
          fi

          # 删除前五行并生成新的 1.json 文件
          tail -n +5 response.tmp > 1.json.new
          rm -f response.tmp

          # 如果原文件不存在，直接认为有更新
          if [ ! -f 1.json ]; then
            mv 1.json.new 1.json
            echo "UPDATED=true" >> $GITHUB_ENV
            exit 0
          fi

          # 对比新旧文件
          if diff -q 1.json 1.json.new >/dev/null; then
            echo "No changes detected."
            echo "UPDATED=false" >> $GITHUB_ENV
            rm 1.json.new
          else
            mv 1.json.new 1.json
            echo "Changes detected."
            echo "UPDATED=true" >> $GITHUB_ENV
          fi

      - name: Commit and push changes
        if: env.UPDATED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add 1.json
          git commit -m "chore: update 1.json"
          git push
